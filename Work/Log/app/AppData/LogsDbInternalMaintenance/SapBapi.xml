<?xml version="1.0" encoding="utf-8" ?>
<ArrayOfDbMaintenanceTable>

  <DbMaintenanceTable>

    <SourceTableName>SapBapi</SourceTableName>
    
    <DestTableName>SapBapiReadOnly</DestTableName>

    <TableIndexColumnNames>Bapi, portalType, AppId, userID, customerID</TableIndexColumnNames>

    <Steps>
      <DbMaintenanceStep IgnoreSqlException="true">
        <Description>
          Try creating table '[DestTableName]' ...
        </Description>

        <Sql>
          CREATE TABLE IF NOT EXISTS `[DestTableName]` (
          `Id` bigint(20) NOT NULL AUTO_INCREMENT,
          `Bapi` varchar(40) NOT NULL,
          `time_stamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
          `dauer` decimal(8,4) DEFAULT NULL,
          `AppId` int(11) DEFAULT NULL,
          `userID` int(11) DEFAULT NULL,
          `customerID` int(11) DEFAULT NULL,
          `kunnr` int(11) DEFAULT NULL,
          `portalType` int(11) DEFAULT NULL,
          `Browser` varchar(30) DEFAULT NULL,
          `QueryString` char(40) DEFAULT NULL,
          PRIMARY KEY (`Id`)
          ) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep IsSqlIndexStatement="true" IgnoreSqlException="true">
        <Description>
          Try dropping indexes on table '[DestTableName]' ...
        </Description>

        <Sql>
          DROP INDEX `i_[DestTableName]_[IndexColumnName]` ON [DestTableName];
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep>
        <Description>
          Cleaning table '[DestTableName]' ...
        </Description>

        <Sql>
          DELETE `[DestTableName]`
          FROM `[DestTableName]`
          JOIN ReadOnlyTables ON ReadOnlyTables.TableName = '[DestTableName]'
          where DATE(time_stamp) >= DATE(ReadOnlyTables.LastSyncDate);
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep>
        <Description>
          Inserting data into table '[DestTableName]' ...
          All rows will be copied that are not in the target table
        </Description>
    
        <Sql>
          INSERT INTO `[DestTableName]`
          (
          `Id` ,
          `QueryString` ,
          `Bapi` ,
          `time_stamp` ,
          `dauer` ,
          `AppId` ,
          `userID` ,
          `customerID` ,
          `kunnr` ,
          `portalType`,
          `Browser`
          )
          SELECT
          [SourceTableName].`Id` ,
          SUBSTRING(LogonContext, 1, 40) ,
          `Bapi` ,
          `time_stamp` ,
          `dauer` ,
          `AppId` ,
          `userID` ,
          `customerID` ,
          `kunnr` ,
          `portalType`,
          `Browser`
          from [SourceTableName] WHERE
          [SourceTableName].`Id` NOT IN (SELECT `Id` FROM `[DestTableName]`);
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep>
        <Description>
          Apply 'now()' as 'Sync Date' for table [DestTableName] ...
        </Description>

        <Sql>
          update ReadOnlyTables
          set LastSyncDate = now()
          where TableName = '[DestTableName]';
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep IgnoreSqlException="true">
        <Description>
          Try parsing missing AppID values from QueryString into AppID column ...
        </Description>

        <Sql>
          SET SQL_SAFE_UPDATES=0;
          update [DestTableName]
          set AppID = REPLACE(SUBSTRING_INDEX(QueryString, '&amp;', 1), 'AppID=','')
          where AppID = 0 and QueryString like 'AppID=%';
        </Sql>
      </DbMaintenanceStep>

      <DbMaintenanceStep IsSqlIndexStatement="true">
        <Description>
          Adding indexes to table '[DestTableName]' ...
        </Description>

        <Sql>
          CREATE INDEX `i_[DestTableName]_[IndexColumnName]` ON `[DestTableName]` (`[IndexColumnName]`);
        </Sql>
      </DbMaintenanceStep>
    </Steps>
  </DbMaintenanceTable>
</ArrayOfDbMaintenanceTable>