@using CkgDomainLogic.Autohaus.Models
@model OptionenDienstleistungen

<div id="DivOptionenDienstleistungen" class="margin-top-20">
    @using (Ajax.BeginForm("OptionenDienstleistungenForm", "Zulassung", null,
                new MvcAjaxOptions { UpdateTargetId = "DivOptionenDienstleistungen", OnComplete = "AjaxFormOptionenDienstleistungenComplete();" },
                    htmlAttributes: new { @class = "form-horizontal label-width-200", id = "AjaxFormOptionenDienstleistungen" }))
    {
        @Html.FormValidationSummary()
        
        
        <div class="dienstleistungen-wrapper">
            
            @Html.HiddenFor(m => m.GewaehlteDienstleistungenString)

            <div class="dienstleistungen-header">
                <span class="header-left">@Localize.AvailableServices</span>
                <span class="header-right">@Localize.SelectedServices</span>
            </div>

            <select multiple id="pre-selected-options" class="multiselect hide" name="pre-selected-options[]">
                @foreach (var dl in Model.AvailableDienstleistungen)
                {
                    <option value="@dl.MaterialNr" @dl.SelectedAsString>@dl.Name</option>
                }
            </select>
        </div>
        
        @Html.HiddenFor(m => m.ZulassungsartMatNr)
        
        @Html.FormCheckBoxFor(m => m.NurEinKennzeichen, new { @class = "m-wrap xsmall" })
        
        @Html.FormCheckBoxFor(m => m.KennzeichenSondergroesse, new { @class = "m-wrap xsmall", onchange = "CheckKennzeichenSondergroesse()" },
                                    postControlHtml: @<text>
                                                            @Html.DropDownListFor(m => m.KennzeichenGroesseId, Model.KennzeichengroesseListForMatNr.ToSelectList(), new { @class = "m-wrap small margin-left-50" })
                                                        </text>)

        @Html.FormCheckBoxFor(m => m.Saisonkennzeichen, new { @class = "m-wrap xsmall", onchange = "CheckSaisonkennzeichen()" },
                                    postControlHtml: @<text>
                                                            @Html.DropDownListFor(m => m.SaisonBeginn, OptionenDienstleistungen.SaisonMonate.ToSelectList(), new { @class = "m-wrap xsmall margin-left-50" })
                                                            @Html.DropDownListFor(m => m.SaisonEnde, OptionenDienstleistungen.SaisonMonate.ToSelectList(), new { @class = "m-wrap xsmall margin-left-5" })
                                                        </text>)
        
        if (Zulassungsdaten.IstGebrauchtzulassung(Model.ZulassungsartMatNr))
        {
            @Html.FormCheckBoxFor(m => m.KennzeichenVorhanden, new { @class = "m-wrap xsmall" })
        }
        else
        {
            @Html.HiddenFor(m => m.KennzeichenVorhanden)
        }

        if (Zulassungsdaten.IstAbmeldung(Model.ZulassungsartMatNr))
        {
            @Html.FormCheckBoxFor(m => m.VorhandenesKennzeichenReservieren, new { @class = "m-wrap xsmall" })
        }
        else
        {
            @Html.HiddenFor(m => m.VorhandenesKennzeichenReservieren)
        }

        if (Zulassungsdaten.IstFirmeneigeneZulassung(Model.ZulassungsartMatNr))
        {
            @Html.FormDatePickerFor(m => m.HaltedauerBis, new { @class = "m-wrap small" })
        }
        else
        {
            @Html.HiddenFor(m => m.HaltedauerBis)
        }

        if (Zulassungsdaten.IstUmkennzeichnung(Model.ZulassungsartMatNr))
        {
            @Html.FormTextBoxFor(m => m.AltesKennzeichen, new { @class = "m-wrap medium uppercase" })
        }
        else
        {
            @Html.HiddenFor(m => m.AltesKennzeichen)
        }
        
        @Html.FormTextAreaFor(m => m.Bemerkung, new { @class = "m-wrap large" })
        

        <script type="text/javascript">

            _modelIsValid = @ViewContext.ViewData.ModelState.IsValid.ToString().ToLower();

            CheckKennzeichenSondergroesse();
            CheckSaisonkennzeichen();
            
            MultiSelectPreparePrivate();

            function MultiSelectPreparePrivate() {
                $('#pre-selected-options').multiSelect();

                /* <2-zeilig> */
                var headerSpanToMove = $(".dienstleistungen-header span.header-right");
                var clone = headerSpanToMove.clone();
                headerSpanToMove.hide();
                $(".ms-container .ms-selection").prepend($("<div></div>").addClass("dienstleistungen-header").addClass("dienstleistungen-selected").html(clone));
                /* </2-zeilig> */

                $('#ms-pre-selected-options > .ms-selectable > .ms-list > li').each(function () {
                    $(this).append('<i class="icon-chevron-right"></i>');
                });
                $('#ms-pre-selected-options > .ms-selection > .ms-list > li').each(function () {
                    $(this).prepend('<i class="icon-ok dienstleistung-gewaehlt"></i>');
                    $(this).append('<i class="icon-remove"></i>');
                });
                $('#ms-pre-selected-options').removeClass('hide');

                $('#pre-selected-options').change(function() {
                    var selectedOptions = '';
                    $('.ms-selection > .ms-list > .ms-selected').each(function () {
                        selectedOptions += (selectedOptions != '' ? ',' : '') + $(this).attr('id').replace(/-selection/, '');
                    });
                    $("#GewaehlteDienstleistungenString").val(selectedOptions);
                });
            }

        </script>
    }
</div>
