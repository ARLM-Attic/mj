<style type="text/css">
    
    span.reqired-fields {
        margin-left: -90px !important;
        white-space: nowrap !important;
    }
    
    div.presets-and-filter {
        background-color: #f9fff9;
        padding: 5px 0 0 0;
        border: 1px solid #f0fcf0;
        margin: 0 0 20px 0;
    }
    div.presets-and-filter input[type='text'] {
        background-color: white!important;
    }
    .span4 a {
        text-align: left!important;   
    }
    
    div.zulassungen-count {
        color: blue;
        font-weight: bold;
        margin-left: 5px;
    }
</style>

<script type="text/javascript">

    var ladeHinweis = '@Localize.LoadingData';
    var _modelIsValid = false;
    var _selectedItemsCount = 0;
    var _validationError = false;

    function FormPreparePrivate() {

        try { FormWizardInitPrivate(); } catch (e) { }

        // move our grid filter form into grid's toolbar:
        GridAllColumnFilterApplyToGrid("GridFahrzeugAuswahl");

        try { MultiSelectPreparePrivate(); } catch (e) { }

        InitSearchableAndEditableDropdowns();

        InitDatePicker();
        
        setTimeout(function() {
            ReFilterGrid();
        }, 800);
    };

    function FormPreparePrivateAjax(step) {
        FormPrepareAjax();
        var stepKey = FormWizard.GetStepKey(step + 1);
        if ('FahrzeugSummary' == stepKey) {
            GridAllColumnFilterApplyToGrid("GridFahrzeugSummary");
        }
        if ('Receipt' == stepKey) {
            $("#GridFahrzeugSummary .t-grouping-header").hide();
            $("#GridFahrzeugSummary .t-grid-filter").hide();
            GridAllColumnFilterApplyToGrid("GridFahrzeugSummary");
        }

        $('.tooltips').tooltip();
    }
    
    function FormWizardInitPrivate() {
        FormWizard.Init(function () {
            FormWizard.ActionsShow(!FormWizard.HasStepKey('FahrzeugAuswahl') && typeof(_formErrorHint) == 'undefined');
        });

        FormWizard.OnNext(function (step, maxSteps) {
            var stepKey = FormWizard.GetStepKey(step - 1);
            if ('FahrzeugAuswahl' == stepKey) {
                return FahrzeugAuswahl();
            }
            if ('FahrzeugSummary' == stepKey) {
                return FahrzeugSummary();
            }

            return true;
        });

        FormWizard.OnPrev(function (step, maxSteps) {
            if ('FahrzeugAuswahl' == FormWizard.GetStepKey(step)) 
                FormWizard.ActionsShow(true);
            return true;
        });

        FormWizard.OnSubmit(function () {

            AjaxRequestNextStep();

            return true;
        });

        FormWizard.OnRestart(function () {
            //alert('Ok, let´s restart! :)');
            LocationReloadWithoutQueryString();
        });
    }

    function GetGrid(gridName) {
        return $("#" + gridName).data("tGrid");
    }

    function GridRefresh(gridName) {
        GetGrid(gridName).pageTo(1);
    }

    function AjaxRequestNextStep() {

        var nextTabKey = FormWizard.GetNextTabKey();

        $.ajax({
            type: "POST",
            url: nextTabKey,
            data: {},
            loadingShow: true,
            success: function (result) {
                if (typeof (result.message) !== "undefined") {
                    alert(result.message);
                    return;
                }
                if (nextTabKey == "Receipt") {
                    $("#GridFahrzeugSummaryWrapper").html("");
                }

                FormWizard.SetNextTabHtmlAndMoveNext(result);
                window.scrollTo(0, 0);
            }
        });    
    }

    function FahrzeugAuswahl() {
        AjaxRequestNextStep();
        return false;
    }

    function FahrzeugSummary() {
        AjaxRequestNextStep();
        return false;
    }

   

    function OnDataBound_GridFahrzeugAuswahl() {
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();

        // prepare multi row selection
        App.initUniform();
        Grid_PrepareMultiRowSelected("GridFahrzeugAuswahl");
    }

    function OnRowDataBound_GridFahrzeugAuswahl(e) {
        var isValid = e.dataItem["IsValid"];

        if (isValid)
            $(e.row).addClass((e.row.sectionRowIndex % 2 == 0) ? "t-grid-selected" : "t-grid-selected-alt");
        else
            $(e.row).addClass((e.row.sectionRowIndex % 2 == 0) ? "t-grid-error" : "t-grid-error-alt");
        }

    function OnLoad_GridFahrzeugAuswahl() {
        $('.t-no-data td').text(ladeHinweis);
    }

    function OnColumnShowHide_GridFahrzeugAuswahl() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridFahrzeugAuswahl() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function OnSelectionChange_GridFahrzeugAuswahl(cb) {

        Grid_FormatMultiRowSelected(cb);

        $.ajax({
            type: "POST",
            url: "FahrzeugAuswahlSelectionChanged",
            data: { vin: cb.val(), isChecked: cb.is(':checked') },
            loadingShow: false,
            success: function (result) {
                _selectedItemsCount = result.allSelectionCount;
                GridFahrzeugAuswahl_MultiSelectUpdate(_selectedItemsCount);
                RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                ShowHideNextButton();
            }
        });
    }

    function GridFahrzeugAuswahl_OnAllSelectionChange(check) {
        $.ajax({
            type: "POST",
            url: "FahrzeugAuswahlSelectionChanged",
            data: { id: "", isChecked: check },
            loadingShow: true,
            success: function (result) {
                _selectedItemsCount = result.allSelectionCount;
                GridFahrzeugAuswahl_MultiSelectUpdate(_selectedItemsCount);
                RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                ShowHideNextButton();
                
                FilterGrid("GridFahrzeugAuswahl");
            }
        });
    }

    function GridFahrzeugAuswahl_MultiSelectUpdate(count) {
        if (count == 0) {
            $("#FahrzeugAuswahlCount").addClass('hide');
            $("#uncheckAllRecords").attr("checked", false);
            $.uniform.update($("#uncheckAllRecords"));
            return;
        }

        $("#FahrzeugAuswahlCount").removeClass('hide');
        $("#FahrzeugAuswahlCount > span").html('Sie haben ' + count + ' Fahrzeug' + (count == 1 ? '' : 'e') + ' ausgewählt!');
        $("#uncheckAllRecords").attr("checked", true);
        $.uniform.update($("#uncheckAllRecords"));
    }

    function InitDatePicker() {
        $('#SelectedZulassungsDatum').datepicker().on('change', function (ev) {
            $.ajax({
                type: "POST",
                url: "OnChangePresetValues",
                data: { value: $('#SelectedZulassungsDatum').val(), type: "SelectedZulassungsDatum" },
                loadingShow: false,
                success: function (result) {
                    _validationError = (result.errorMessage != "");
                    if (_validationError){
                        SpanAlertError("MessageFahrzeugAuswahl", result.errorMessage, 2500);
                        RefreshZulassungenCountForDateAndPdi(0, 0);
                    }
                    else
                        RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);

                    ShowHideNextButton();
                }
            });
        });
    }

    function OnDropdownChanged_SelectedKennzeichenSerie(value) {
        $.ajax({
            type: "POST",
            url: "OnChangePresetValues",
            data: { value: value, type: "SelectedKennzeichenSerie" },
            loadingShow: false,
            success: function (result) {
                ShowHideNextButton();
            }
        });
    }

    function OnDropdownChanged_SelectedPdi(val) {
        OnChangeFilterValues("SelectedPdi", val);
    }

    function OnDropdownChanged_SelectedModel(val) {
        OnChangeFilterValues("SelectedModel", val);
    }

    function OnDropdownChanged_SelectedModelId(val) {
        OnChangeFilterValues("SelectedModelId", val);
    }

    function OnChangeFilterValues(type, value) {
        $.ajax({
            type: "POST",
            url: "OnChangeFilterValues",
            data: { value: value, type: type },
            loadingShow: false,
            success: function (result) {
                RefreshZulassungenCountForDateAndPdi(result.zulassungenAnzahlGesamtTotal, result.zulassungenAnzahlPdiTotal);
                ReFilterGrid();
            }
        });
    }

    function RefreshZulassungenCountForDateAndPdi(zulassungenAnzahlGesamtTotal, zulassungenAnzahlPdiTotal) {
        if (zulassungenAnzahlGesamtTotal == 0)
            $("#zulassungenAnzahlGesamtTotal").addClass("hide");
        else {
            $("#zulassungenAnzahlGesamtTotal").html("@Localize.RegistrationAmountForThisDay: " + zulassungenAnzahlGesamtTotal);
            $("#zulassungenAnzahlGesamtTotal").removeClass("hide");
        }

        if (zulassungenAnzahlPdiTotal == 0)
            $("#zulassungenAnzahlPdiTotal").addClass("hide");
        else {
            $("#zulassungenAnzahlPdiTotal").html("@Localize.RegistrationAmountForThisDayAndPdi: " + zulassungenAnzahlPdiTotal);
            $("#zulassungenAnzahlPdiTotal").removeClass("hide");
        }
    }

    function ShowHideNextButton() {
        
        var nextButtonValid = 
            $('#SelectedZulassungsDatum').val() != '' && $('#SelectedZulassungsDatum').val() != null && 
            //$('#SelectedKennzeichenSerie').val() != '-' && 
            _selectedItemsCount > 0 && !_validationError;

        FormWizard.ActionsShow(nextButtonValid);
    }

    function ReFilterGrid() {
        FilterGrid("GridFahrzeugAuswahl");
    }



    // <Fahrzeug Summary>


    function OnDataBound_GridFahrzeugSummary() {
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
    }

    function OnColumnShowHide_GridFahrzeugSummary() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridFahrzeugSummary() {
        FilteredData_Grid_OnColumnReorder($(this));
    }


    // </Fahrzeug Summary>

</script>

