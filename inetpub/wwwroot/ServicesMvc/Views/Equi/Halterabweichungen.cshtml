@using CkgDomainLogic.Equi.ViewModels
@model HalterabweichungenViewModel

<h3 class="page-title" id="headerTitle">@Localize.Equi_Halterabweichungen <small></small></h3>

@section LayoutScript { _controlGroupValidationType = "individual"; }

@Html.SpanAlert("spanAlertHalterabweichungen")

<div id="divHalterabweichungenGrid">
    @Html.Partial("Halterabweichungen/HalterabweichungenGrid", Model)
</div>

<script type="text/javascript">

    var ladeHinweis = '@Localize.LoadingData';
    var selectedFzgHalterabweichungen;

    function GridHalterabweichungen_SelectAll(setSelected) {
        $.ajax(
        {
            type: "POST",
            url: "HalterabweichungenSelectAll",
            loadingShow: true,
            success: function (data) {
                var items = JSON.parse(data);
                
                if (setSelected) {
                    items.forEach(function(strItem) {
                        if (jQuery.inArray(strItem, selectedFzgHalterabweichungen) < 0) {
                            selectedFzgHalterabweichungen.push(strItem);
                        }
                    });
                } else {
                    items.forEach(function(strItem) {
                        if (jQuery.inArray(strItem, selectedFzgHalterabweichungen) > -1) {
                            selectedFzgHalterabweichungen = $.grep(selectedFzgHalterabweichungen, function(item, index) {
                                return item != strItem;
                            });
                        }
                    });
                }

                GridRefresh();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }

    function InitGridSelectionPersister() {
        $('#GridHalterabweichungen').on('change', ':checkbox[id=cbxCheckAll]', function(e) {
            GridHalterabweichungen_SelectAll($(this).is(':checked'));
        });

        // Selektion merken (wichtig bei Paging etc.)
        $('#GridHalterabweichungen').on('change', ':checkbox[name=cbxCheckRow]', function(e) {
            var cbx = $(this);
            var grid = $('#GridHalterabweichungen').data("tGrid");
            var fin = grid.dataItem(cbx.closest('tr')).Fahrgestellnummer;
            if (cbx.is(':checked')) {
                selectedFzgHalterabweichungen.push(fin);
            } else {
                selectedFzgHalterabweichungen = $.grep(selectedFzgHalterabweichungen, function(item, index) {
                    return item != fin;
                });
            }
        });
        
        // Bei Filteränderung "checkall"-Checkbox zurücksetzen
        $('#GridHalterabweichungen').on('filter_all_columns', function(e) {
            $("#cbxCheckAll").attr('checked', false);
            $("#cbxCheckAll").closest("span").removeClass("checked");
        });
    }
    
    function InitGridRowSelectionByClick() {
        $('#GridHalterabweichungen table tbody tr').click(function (e) {
            var clickedElement = e.target;
            var tr = $(this);
            tr.find('td input[type=checkbox]').each(function () {
                if (this == clickedElement)
                    return false;
                this.checked = !($(this).is(':checked'));
                $(this).trigger('change');
                return true;
            });
        });
    }

    function FormPreparePrivate() {
        GridAllColumnFilterApplyToGrid("GridHalterabweichungen");
        selectedFzgHalterabweichungen = [];
        InitGridSelectionPersister();
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridHalterabweichungen").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridHalterabweichungenItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridHalterabweichungen() {
        // Selektion rekonstruieren
        $('#GridHalterabweichungen :checkbox[name=cbxCheckRow]').each(function () {
            var cbx = $(this);
            var fin = $('#GridHalterabweichungen').data("tGrid").dataItem(cbx.closest('tr')).Fahrgestellnummer;
            cbx.attr('checked', jQuery.inArray(fin, selectedFzgHalterabweichungen) > -1);
        });

        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
        
        InitGridRowSelectionByClick();
    }

    function OnLoad_GridHalterabweichungen() {
        $('.t-no-data td').text(ladeHinweis);
    }

    function OnColumnShowHide_GridHalterabweichungen() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridHalterabweichungen() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function ApplyHalterabweichungenGridPartialView(result) {
        $("#divHalterabweichungenGrid").html(result);
        GridAllColumnFilterApplyToGrid("GridHalterabweichungen");
        InitGridSelectionPersister();
    }

    function SaveHalterabweichungen() {
        $.ajax(
        {
            type: "POST",
            url: "SaveHalterabweichungen",
            loadingShow: true,
            data: { selectedItems: JSON.stringify(selectedFzgHalterabweichungen) },
            success: function (result) {
                ApplyHalterabweichungenGridPartialView(result);
                if (_modelStateValid == 'true') {
                    var successMessage = '@Localize.SaveSuccessful.ToJavascriptString()';
                    SpanAlertSuccess("spanAlertHalterabweichungen", successMessage, 1800);
                }
                FormPreparePrivateAjax();
            },
            error: function (result) {
                SpanAlertWarning("spanAlertHalterabweichungen", result.data, 5000);
            }
        });

        return false;
    }

</script>
