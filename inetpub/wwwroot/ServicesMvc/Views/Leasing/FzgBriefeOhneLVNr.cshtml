@using CkgDomainLogic.Leasing.ViewModels
@model LeasingBriefeOhneLVNrViewModel

<h3 class="page-title" id="headerTitle">Erfassung fehlender Leasingvertragsnummern <small></small></h3>

<p id="lblError"></p>

@section LayoutScript { _controlGroupValidationType = "individual"; }

<div id="divUnzugelFzgGrid">
    @Html.Partial("UnzugelFzg/UnzugelFzgGrid", Model)
</div>

<div class="form-actions">
    <button type="button" id="btnSave" class="btn blue mini float-right" onclick="SaveChanges();">@Localize.Apply</button>
    <button type="button" id="btnReturn" class="btn blue mini float-right hide" onclick="EditChanges();">@Localize.Correction</button>
    <button type="button" id="btnSubmit" class="btn blue mini float-right hide" onclick="SubmitChanges();">@Localize.Send</button>
    <button type="button" id="btnBackToStart" class="btn blue mini float-right hide" onclick="BackToStart();">@Localize.Continue</button>
</div>

<script type="text/javascript">

    function FormPreparePrivate() {
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridUnzugelFzgItems").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridUnzugelFzgItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridUnzugelFzg() {
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
    }

    function OnColumnShowHide_GridUnzugelFzg() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridUnzugelFzg() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function ApplyUnzugelFzgGridPartialView(result) {
        $("#divUnzugelFzgGrid").html(result);
    }

    function ApplyGridSubmitMode(blnSubmitMode) {
        var grid = $("#GridUnzugelFzg").data('tGrid');

        if (blnSubmitMode == true) {
            $("#GridUnzugelFzg > .t-grid-toolbar > .excel").removeClass("hidden");
            $("#GridUnzugelFzg > .t-grid-toolbar > .pdf").removeClass("hidden");
            grid.hideColumn("Leasingvertragsnummer");
            grid.showColumn("LeasingvertragsnummerShow");
            grid.showColumn("StatusShow");
        } else {
            $("#GridUnzugelFzg > .t-grid-toolbar > .excel").addClass("hidden");
            $("#GridUnzugelFzg > .t-grid-toolbar > .pdf").addClass("hidden");
            grid.hideColumn("StatusShow");
            grid.hideColumn("LeasingvertragsnummerShow");
            grid.showColumn("Leasingvertragsnummer");
        }
    }

    // Geänderte Daten übernehmen und zur Bestätigungsansicht wechseln
    function SaveChanges() {
        ApplyGridSubmitMode(true);
        $("#btnSave").hide();
        $("#btnReturn").show();
        $("#btnSubmit").show();
        
        var grid = $("#GridUnzugelFzg").data('tGrid');
        if (grid.hasChanges()) {
            grid.submitChanges();
        } else {
            // Wenn keine Datenänderungen, trotzdem Server-Action aufrufen, um serverseitig in Submit-Mode zu gelangen
            SwitchToSubmitMode();
        }
        
        return false;
    }
    
    // Serverseitigen Wechsel in Submit-Mode und Grid-Refresh forcieren
    function SwitchToSubmitMode() {
        $.ajax(
        {
            type: "POST",
            url: "BriefeOhneLVNrSwitchToSubmitMode",
            data: {  },
            success: function () {
                var grid = $("#GridUnzugelFzg").data('tGrid');
                grid.ajaxRequest();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }

    // zur Datenbearbeitungs-/Korrekturansicht zurückkehren
    function EditChanges() {
        $.ajax(
        {
            type: "POST",
            url: "BriefeOhneLVNrEditChanges",
            data: {  },
            success: function (result) {
                ApplyUnzugelFzgGridPartialView(result);
                ApplyGridSubmitMode(false);
                $("#btnReturn").hide();
                $("#btnSubmit").hide();
                $("#btnSave").show();
                FormPreparePrivateAjax();
            }
        });

        return false;
    }
    
    // Daten endgültig speichern/absenden
    function SubmitChanges() {
        $.ajax(
        {
            type: "POST",
            url: "BriefeOhneLVNrSubmitChanges",
            data: {  },
            success: function (result) {
                ApplyUnzugelFzgGridPartialView(result);
                ApplyGridSubmitMode(true);
                $("#btnReturn").hide();
                $("#btnSubmit").hide();
                $("#btnBackToStart").show();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }
    
    // zur initialen Ansicht zurückkehren (inkl. serverseitigem Daten-Neuladen)
    function BackToStart() {
        $.ajax(
        {
            type: "POST",
            url: "BriefeOhneLVNrReinitModel",
            data: {  },
            success: function (result) {
                ApplyUnzugelFzgGridPartialView(result);
                ApplyGridSubmitMode(false);
                $("#btnBackToStart").hide();
                $("#btnSave").show();
                FormPreparePrivateAjax();
            }
        });

        return false;
    }

</script>
