@using CkgDomainLogic.Leasing.ViewModels
@model LeasingAbmeldungViewModel

<h3 class="page-title" id="headerTitle">Abmeldung beauftragen <small></small></h3>

<p id="lblError"></p>

@section LayoutScript { _controlGroupValidationType = "individual"; }

<div id="divAbzumeldendeFzgGrid">
    @Html.Partial("Abmeldung/AbzumeldendeFzgGrid", Model)
</div>

<div class="form-actions">
    <button type="button" id="btnSave" class="btn blue mini float-right" onclick="SaveChanges();">@Localize.Apply</button>
    <button type="button" id="btnReturn" class="btn blue mini float-right hide" onclick="EditChanges();">@Localize.Correction</button>
    <button type="button" id="btnSubmit" class="btn blue mini float-right hide" onclick="SubmitChanges();">@Localize.Send</button>
    <button type="button" id="btnBackToStart" class="btn blue mini float-right hide" onclick="BackToStart();">@Localize.Continue</button>
</div>

<script type="text/javascript">

    var selectedFzgBeauftragungAbmeldung;

    function GridAbzumeldendeFzg_SelectAll() {
        $.ajax(
        {
            type: "POST",
            url: "AbmeldungenSelectAll",
            loadingShow: true,
            success: function (data) {
                selectedFzgBeauftragungAbmeldung = JSON.parse(data);
                var grid = $("#GridAbzumeldendeFzg").data('tGrid');
                grid.ajaxRequest();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }

    function InitGridSelectionPersister() {
        $('#GridAbzumeldendeFzg').on('change', ':checkbox[id=cbxCheckAll]', function(e) {
            var cbx = $(this);

            if (cbx.is(':checked')) {
                GridAbzumeldendeFzg_SelectAll();
            } else {
                selectedFzgBeauftragungAbmeldung = [];
                var grid = $("#GridAbzumeldendeFzg").data('tGrid');
                grid.ajaxRequest();
                FormPreparePrivateAjax();
            }
        });

        // Selektion merken (wichtig bei Paging etc.)
        $('#GridAbzumeldendeFzg').on('change', ':checkbox[name=cbxCheckRow]', function(e) {
            var cbx = $(this);
            var grid = $('#GridAbzumeldendeFzg').data("tGrid");
            var fin = grid.dataItem(cbx.closest('tr')).Fahrgestellnummer;
            if (cbx.is(':checked')) {
                selectedFzgBeauftragungAbmeldung.push(fin);
            } else {
                selectedFzgBeauftragungAbmeldung = $.grep(selectedFzgBeauftragungAbmeldung, function(item, index) {
                    return item != fin;
                });
            }
        });
    }

    function FormPreparePrivate() {
        GridAllColumnFilterApplyToGrid("GridAbzumeldendeFzg");
        selectedFzgBeauftragungAbmeldung = [];
        InitGridSelectionPersister();
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridAbzumeldendeFzgItems").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridAbzumeldendeFzgItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridAbzumeldendeFzg() {
        // Selektion rekonstruieren
        $('#GridAbzumeldendeFzg :checkbox[name=cbxCheckRow]').each(function () {
            var cbx = $(this);
            var fin = $('#GridAbzumeldendeFzg').data("tGrid").dataItem(cbx.closest('tr')).Fahrgestellnummer;
            cbx.attr('checked', jQuery.inArray(fin, selectedFzgBeauftragungAbmeldung) > -1);
        });
        
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
    }

    function OnColumnShowHide_GridAbzumeldendeFzg() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridAbzumeldendeFzg() {
        FilteredData_Grid_OnColumnReorder($(this));
    }
    
    function ApplyAbzumeldendeFzgGridPartialView(result) {
        $("#divAbzumeldendeFzgGrid").html(result);
        GridAllColumnFilterApplyToGrid("GridAbzumeldendeFzg");
        InitGridSelectionPersister();
    }
    
    function ApplyGridSubmitMode(blnSubmitMode) {
        var grid = $("#GridAbzumeldendeFzg").data('tGrid');

        if (blnSubmitMode == true) {
            grid.hideColumn("Freigabe");
            grid.showColumn("FreigabeShow");
            grid.showColumn("StatusShow");
        } else {
            grid.hideColumn("StatusShow");
            grid.hideColumn("FreigabeShow");
            grid.showColumn("Freigabe");
        }
    }

    // Geänderte Daten übernehmen und zur Bestätigungsansicht wechseln
    function SaveChanges() {
        ApplyGridSubmitMode(true);
        $("#btnSave").hide();
        $("#btnReturn").show();
        $("#btnSubmit").show();
        
        SwitchToSubmitMode();
        
        return false;
    }
    
    // Serverseitigen Wechsel in Submit-Mode und Grid-Refresh forcieren
    function SwitchToSubmitMode() {
        $.ajax(
        {
            type: "POST",
            url: "AbmeldungenSwitchToSubmitMode",
            loadingShow: true,
            data: { selectedItems: JSON.stringify(selectedFzgBeauftragungAbmeldung) },
            success: function () {
                var grid = $("#GridAbzumeldendeFzg").data('tGrid');
                grid.pageTo(1);
                grid.ajaxRequest();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }

    // zur Datenbearbeitungs-/Korrekturansicht zurückkehren
    function EditChanges() {
        $.ajax(
        {
            type: "POST",
            url: "AbmeldungenEditChanges",
            loadingShow: true,
            data: {  },
            success: function (result) {
                ApplyAbzumeldendeFzgGridPartialView(result);
                ApplyGridSubmitMode(false);
                $("#btnReturn").hide();
                $("#btnSubmit").hide();
                $("#btnSave").show();
                FormPreparePrivateAjax();
            }
        });

        return false;
    }
    
    // Daten endgültig speichern/absenden
    function SubmitChanges() {
        $.ajax(
        {
            type: "POST",
            url: "AbmeldungenSubmitChanges",
            loadingShow: true,
            data: {  },
            success: function (result) {
                ApplyAbzumeldendeFzgGridPartialView(result);
                ApplyGridSubmitMode(true);
                $("#btnReturn").hide();
                $("#btnSubmit").hide();
                $("#btnBackToStart").show();
                FormPreparePrivateAjax();
            },
        });

        return false;
    }
    
    // zur initialen Ansicht zurückkehren (inkl. serverseitigem Daten-Neuladen)
    function BackToStart() {
        $.ajax(
        {
            type: "POST",
            url: "AbmeldungenReinitModel",
            loadingShow: true,
            data: {  },
            success: function (result) {
                ApplyAbzumeldendeFzgGridPartialView(result);
                ApplyGridSubmitMode(false);
                $("#btnBackToStart").hide();
                $("#btnSave").show();
                FormPreparePrivateAjax();
            }
        });

        return false;
    }

</script>
