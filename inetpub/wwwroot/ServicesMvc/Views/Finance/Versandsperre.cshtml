@using CkgDomainLogic.Finance.ViewModels
@model FinanceVersandsperreViewModel

<h3 class="page-title" id="headerTitle">@Localize.Finance_Versandsperre <small></small></h3>

@section LayoutScript { _controlGroupValidationType = "individual"; }

@Html.SpanAlert("spanAlertVersandsperre")

@Html.Partial("Versandsperre/VersandsperreSuche", Model.DataService.Suchparameter)

<div id="divVersandsperreGrid"></div>

<script type="text/javascript">

    var selectedIdsVersandsperre;

    function InitGridSelectionPersister() {
        // Selektion merken (wichtig bei Paging etc.)
        $('#GridVersandsperre').on('change', ':checkbox[name=cbxCheckRow]', function (e) {
            var cbx = $(this);
            var grid = $('#GridVersandsperre').data("tGrid");
            var id = grid.dataItem(cbx.closest('tr')).PAID;
            if (cbx.is(':checked')) {
                selectedIdsVersandsperre.push(id);
            } else {
                selectedIdsVersandsperre = $.grep(selectedIdsVersandsperre, function (item, index) {
                    return item != id;
                });
            }
        });
    }

    function FormPreparePrivate() {
        GridAllColumnFilterApplyToGrid("GridVersandsperre");
        selectedIdsVersandsperre = [];
        InitGridSelectionPersister();
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridVersandsperre").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridVersandsperreItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridVersandsperre() {
        // Selektion rekonstruieren
        $('#GridVersandsperre :checkbox[name=cbxCheckRow]').each(function () {
            var cbx = $(this);
            var id = $('#GridVersandsperre').data("tGrid").dataItem(cbx.closest('tr')).PAID;
            cbx.attr('checked', jQuery.inArray(id, selectedIdsVersandsperre) > -1);
        });

        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
    }

    function OnColumnShowHide_GridVersandsperre() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridVersandsperre() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function TryGridRefresh() {
        // Refresh grid only
        if (typeof (GetGrid()) !== "undefined") {
            GetGrid().ajaxRequest();
        }
    }

    function ApplyVersandsperreGridPartialView(result) {
        $("#divVersandsperreGrid").html(result);
        GridAllColumnFilterApplyToGrid("GridVersandsperre");
        InitGridSelectionPersister();
    }

    function ShowVersandsperreSearchResult(result) {
        $("#btnBackToSearch").show();
        $("#divVersandsperreSuche").slideUp();
        $("#divVersandsperreGrid").slideDown();
        ApplyVersandsperreGridPartialView(result);
    }

    function CloseVersandsperreSearchResult() {
        $("#btnBackToSearch").hide();
        $("#divVersandsperreGrid").slideUp(function () { $("#divVersandsperreSuche").delay(200).slideDown(); window.scrollTo(0, 0); });
        FormPreparePrivateAjax();
    }

    function SaveVersandsperren() {
        $.ajax(
        {
            type: "POST",
            url: "SaveVersandsperren",
            loadingShow: true,
            data: { selectedItems: JSON.stringify(selectedIdsVersandsperre) },
            success: function (result) {
                ApplyVersandsperreGridPartialView(result);
                if (_modelStateValid == 'true') {
                    var successMessage = '@Localize.SaveSuccessful.ToJavascriptString()';
                    SpanAlertSuccess("spanAlertVersandsperre", successMessage, 1800);
                }
                FormPreparePrivateAjax();
            },
            error: function (result) {
                SpanAlertWarning("spanAlertVersandsperre", result.data, 5000);
            }
        });

        return false;
    }

</script>
