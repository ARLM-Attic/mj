@using CkgDomainLogic.Finance.ViewModels
@model FinanceAktivcheckViewModel

<h3 class="page-title" id="headerTitle">Aktivcheck <small></small></h3>

@section LayoutScript { _controlGroupValidationType = "individual"; }

@Html.SpanAlert("spanAlertAktivcheck")

<div id="closeAktivcheckEdit" onclick="CloseAktivcheckEdit();" class="icon-close"></div>

<div id="divAktivcheckGrid">
    @Html.Partial("Aktivcheck/AktivcheckGrid", Model)
</div>

<div id="divAktivcheckEdit"></div>

<input type="hidden" id="ihMailOk" value="@Localize.YourContactRequestWasSuccessfullySent"/>
<input type="hidden" id="ihMailError" value="@Localize.EmailSentError"/>

<script type="text/javascript">

    function FormPreparePrivate() {
        GridAllColumnFilterApplyToGrid("GridAktivcheckTreffer");
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridAktivcheckTreffer").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridAktivcheckTrefferItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridAktivcheckTreffer() {
        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
    }

    function OnRowDataBound_GridAktivcheckTreffer(e) {
        var btn = $(e.row).find(".aktivcheckEmailButton");
        btn.removeClass('tooltips');

        if (e.dataItem.Kontaktanfrage == true) {
            btn.prop('disabled', 'disabled');       
        } else {
            btn.prop('disabled', '');
            btn.addClass('tooltips');
        }

        var icon = $(e.row).find(".iconStatusIndicator");
        icon.removeClass('warning danger success info important');
        
        switch (e.dataItem.Klassifizierung) {
            case "01":
                // Klärfall
                icon.addClass('warning');
                break;
                
            case "02":
                // Betrugsversuch
                icon.addClass('danger');
                break;
                
            default:
                icon.addClass('success');
                break;
        }
    }

    function OnColumnShowHide_GridAktivcheckTreffer() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridAktivcheckTreffer() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function AktivcheckEdit(id) {
        $.ajax({
            type: "POST",
            url: "ShowAktivcheckEdit",
            data: { vorgangId: id.toString() },
            loadingShow: true,
            success: function (result) {
                ShowAktivcheckEdit(result);
            },
            error: function (result) {
                SpanAlertWarning("spanAlertAktivcheck", result.data, 5000);
            }
        });
    }

    function AktivcheckEmail(id) {
        $.ajax({
            type: "POST",
            url: "EmailAktivcheck",
            data: { vorgangId: id.toString() },
            loadingShow: true,
            success: function (result) {
                ShowEmailSuccess(result);
            },
            error: function (result) {
                SpanAlertWarning("spanAlertAktivcheck", result.data, 5000);
            }
        });
    }

    function ShowAktivcheckEdit(result, showCloseButton) {
        $("#divAktivcheckEdit").html(result);
        $("#divAktivcheckGrid").slideUp();
        $("#divAktivcheckEdit").slideDown();

        if (showCloseButton == null) showCloseButton = true;
        if (showCloseButton) {
            $("#closeAktivcheckEdit").show();
        }

        FormPreparePrivateAjax();
    }

    function ShowEmailSuccess(result) {
        var meldung;
        if (result == "OK") {
            meldung = $("#ihMailOk").val();
            SpanAlertSuccess("spanAlertAktivcheck", meldung, 1800);
            TryGridRefresh();
        } else {
            meldung = $("#ihMailError").val();
            SpanAlertWarning("spanAlertAktivcheck", meldung, 5000);
        }
    }

    function CloseAktivcheckEdit() {
        $("#closeAktivcheckEdit").hide();
        $("#divAktivcheckEdit").slideUp(function () {
            $("#divAktivcheckGrid").delay(200).show();
            window.scrollTo(0, 0);
        });
        TryGridRefresh();
    }

    function TryGridRefresh() {
        // Refresh grid only
        if (typeof (GetGrid()) !== "undefined") {
            GetGrid().ajaxRequest();
        }
    }

</script>
