@using CkgDomainLogic.Insurance.ViewModels
@model VertragsverlaengerungViewModel

<h3 class="page-title" id="headerTitle">@Localize.Insurance_Vertragsverlaengerung <small></small></h3>

@section LayoutScript { _controlGroupValidationType = "individual"; }

@Html.SpanAlert("spanAlertVertragsverlaengerung")

<div id="divVertragsdatenGrid">
    @Html.Partial("Vertragsverlaengerung/VertragsdatenGrid", Model)
</div>

<script type="text/javascript">

    var selectedIdsVertragsverlaengerung;

    function InitGridSelectionPersister() {
        // Selektion merken (wichtig bei Paging etc.)
        $('#GridVertragsdaten').on('change', ':checkbox[name=cbxCheckRow]', function (e) {
            var cbx = $(this);
            var grid = $('#GridVertragsdaten').data("tGrid");
            var id = grid.dataItem(cbx.closest('tr')).ID;
            if (cbx.is(':checked')) {
                selectedIdsVertragsverlaengerung.push(id);
            } else {
                selectedIdsVertragsverlaengerung = $.grep(selectedIdsVertragsverlaengerung, function (item, index) {
                    return item != id;
                });
            }
        }); 
    }
    
    function InitGridRowSelectionByClick() {
        $('#GridVertragsdaten table tbody tr').click(function (e) {
            var clickedElement = e.target;
            var tr = $(this);
            tr.find('td input[type=checkbox]').each(function () {
                if (this == clickedElement)
                    return false;
                this.checked = !($(this).is(':checked'));
                $(this).trigger('change');
                return true;
            });
        });
    }

    function FormPreparePrivate() {
        GridAllColumnFilterApplyToGrid("GridVertragsdaten");
        selectedIdsVertragsverlaengerung = [];
        InitGridSelectionPersister();
    }

    function FormPreparePrivateAjax() {
        FormPrepareAjax();
    }

    function GetGrid() {
        return $("#GridVertragsdaten").data("tGrid");
    }

    function GridLoadingHide() {
        // needed for chrome browser: Explicitely hide grids loading icon on multiple subsequent grid ajax requests (because of filter control initializing)
        setTimeout('$("#GridVertragsdatenItems .t-grid-pager .t-status .t-icon").removeClass("t-loading")', 500);
    }

    function GridRefresh() {
        GetGrid().ajaxRequest();
    }

    function OnDataBound_GridVertragsdaten() {
        // Selektion rekonstruieren
        $('#GridVertragsdaten :checkbox[name=cbxCheckRow]').each(function () {
            var cbx = $(this);
            var id = $('#GridVertragsdaten').data("tGrid").dataItem(cbx.closest('tr')).ID;
            cbx.attr('checked', jQuery.inArray(id, selectedIdsVertragsverlaengerung) > -1);
        });

        FilteredData_Grid_OnDataBound($(this));
        $('.tooltips').tooltip();
        
        InitGridRowSelectionByClick();
    }

    function OnRowDataBound_GridVertragsdaten(e) {
        var resttage = e.dataItem.Resttage;

        if (resttage >= 42) {
            e.row.style.backgroundColor = "green";
        } else if (resttage >= 7) {
            e.row.style.backgroundColor = "yellow";
        } else {
            e.row.style.backgroundColor = "red";
        }
    }

    function OnColumnShowHide_GridVertragsdaten() {
        FilteredData_Grid_OnColumnShowHide($(this));
    }

    function OnColumnReorder_GridVertragsdaten() {
        FilteredData_Grid_OnColumnReorder($(this));
    }

    function TryGridRefresh() {
        // Refresh grid only
        if (typeof (GetGrid()) !== "undefined") {
            GetGrid().ajaxRequest();
        }
    }
    
    function SaveVertragsverlaengerungen() {
        $.ajax(
        {
            type: "POST",
            url: "SaveVertragsverlaengerungen",
            loadingShow: true,
            data: { selectedItems: JSON.stringify(selectedIdsVertragsverlaengerung) },
            success: function (result) {
                $("#divVertragsdatenGrid").html(result);
                GridAllColumnFilterApplyToGrid("GridVertragsdaten");
                if (_modelStateValid == 'true') {
                    var successMessage = '@Localize.SaveSuccessful.ToJavascriptString()';
                    SpanAlertSuccess("spanAlertVertragsverlaengerung", successMessage, 1800);
                }
                FormPreparePrivateAjax();
            },
            error: function (result) {
                SpanAlertWarning("spanAlertVertragsverlaengerung", result.data, 5000);
            }
        });

        return false;
    }

</script>
